@model CatalogoFilmesMeteo.Models.Filme

@{
    ViewData["Title"] = "Editar Filme";
}

<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-action="Index">
                    <i class="fas fa-home me-1"></i>Catálogo
                </a>
            </li>
            <li class="breadcrumb-item">
                <a asp-action="Detalhes" asp-route-id="@Model.Id">@Model.Titulo</a>
            </li>
            <li class="breadcrumb-item active">Editar</li>
        </ol>
    </nav>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow border-0">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-edit me-2"></i>Editar Filme
                </h4>
            </div>
            <div class="card-body">
                <form asp-action="Editar" method="post">
                    <input type="hidden" asp-for="Id" />
                    <input type="hidden" asp-for="TmdbId" />
                    <input type="hidden" asp-for="PosterPath" />
                    <input type="hidden" asp-for="DataCriacao" />
                    <input type="hidden" asp-for="NotaMedia" />
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-lock me-2"></i>
                        <strong>Atenção:</strong> Os dados do TMDb (título, sinopse, gênero, etc.) são somente leitura e não podem ser editados. Apenas os campos de localização podem ser alterados.
                    </div>
                    
                    <h5 class="mb-3 mt-4">
                        <i class="fas fa-film text-primary me-2"></i>
                        Informações do Filme (Somente Leitura)
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-film me-1"></i>Título
                                <span class="badge bg-secondary ms-2">TMDb</span>
                            </label>
                            <div class="form-control bg-light" style="padding: 0.375rem 0.75rem;">
                                @Model.Titulo
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-language me-1"></i>Título Original
                                <span class="badge bg-secondary ms-2">TMDb</span>
                            </label>
                            <div class="form-control bg-light" style="padding: 0.375rem 0.75rem;">
                                @Model.TituloOriginal
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-book me-1"></i>Sinopse
                            <span class="badge bg-secondary ms-2">TMDb</span>
                        </label>
                        <div class="form-control bg-light" style="padding: 0.375rem 0.75rem; min-height: 100px;">
                            @(string.IsNullOrEmpty(Model.Sinopse) ? "Sinopse não disponível" : Model.Sinopse)
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                <i class="fas fa-calendar me-1"></i>Data de Lançamento
                                <span class="badge bg-secondary ms-2">TMDb</span>
                            </label>
                            <div class="form-control bg-light" style="padding: 0.375rem 0.75rem;">
                                @if (Model.DataLancamento.HasValue)
                                {
                                    @Model.DataLancamento.Value.ToString("dd/MM/yyyy")
                                }
                                else
                                {
                                    <span class="text-muted">Não informado</span>
                                }
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                <i class="fas fa-clock me-1"></i>Duração (minutos)
                                <span class="badge bg-secondary ms-2">TMDb</span>
                            </label>
                            <div class="form-control bg-light" style="padding: 0.375rem 0.75rem;">
                                @if (Model.Duracao.HasValue)
                                {
                                    @($"{Model.Duracao} minutos")
                                }
                                else
                                {
                                    <span class="text-muted">Não informado</span>
                                }
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                <i class="fas fa-star me-1"></i>Nota Média
                                <span class="badge bg-secondary ms-2">TMDb</span>
                            </label>
                            <div class="form-control bg-light" style="padding: 0.375rem 0.75rem;">
                                @if (Model.NotaMedia.HasValue)
                                {
                                    <span class="badge bg-warning text-dark fs-6">
                                        <i class="fas fa-star me-1"></i>@Model.NotaMedia.Value.ToString("F1")/10
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted">Não avaliado</span>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-tags me-1"></i>Gênero
                                <span class="badge bg-secondary ms-2">TMDb</span>
                            </label>
                            <div class="form-control bg-light" style="padding: 0.375rem 0.75rem;">
                                @(string.IsNullOrEmpty(Model.Genero) ? "Não informado" : Model.Genero)
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-globe me-1"></i>Língua
                                <span class="badge bg-secondary ms-2">TMDb</span>
                            </label>
                            <div class="form-control bg-light" style="padding: 0.375rem 0.75rem;">
                                @(string.IsNullOrEmpty(Model.Lingua) ? "Não informado" : Model.Lingua)
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-users me-1"></i>Elenco Principal
                            <span class="badge bg-secondary ms-2">TMDb</span>
                        </label>
                        <div class="form-control bg-light" style="padding: 0.375rem 0.75rem;">
                            @(string.IsNullOrEmpty(Model.ElencoPrincipal) ? "Não informado" : Model.ElencoPrincipal)
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">
                        <i class="fas fa-map-marker-alt text-primary me-2"></i>
                        Localização e Previsão do Tempo
                    </h5>
                    
                    <div class="mb-3">
                        <label asp-for="CidadeReferencia" class="form-label">
                            <i class="fas fa-city me-1"></i>Cidade de Referência
                        </label>
                        <div class="input-group">
                            <input asp-for="CidadeReferencia" class="form-control" id="cidadeEdit" placeholder="Ex: São Paulo" />
                            <button type="button" class="btn btn-outline-secondary" id="btnBuscarCoordenadasEdit" title="Buscar coordenadas automaticamente">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Clique em "Buscar" para preencher coordenadas automaticamente via Nominatim.
                        </small>
                        <span asp-validation-for="CidadeReferencia" class="text-danger"></span>
                        <div id="coordenadasStatusEdit" class="mt-2"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Latitude" class="form-label">
                                <i class="fas fa-map-pin me-1"></i>Latitude
                            </label>
                            <input asp-for="Latitude" type="number" step="any" class="form-control" id="latitudeEdit" min="-90" max="90" placeholder="-23.550520" />
                            <span asp-validation-for="Latitude" class="text-danger"></span>
                            <small class="form-text text-danger d-none" id="latErrorEdit">
                                Latitude deve estar entre -90 e 90
                            </small>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label asp-for="Longitude" class="form-label">
                                <i class="fas fa-map-pin me-1"></i>Longitude
                            </label>
                            <input asp-for="Longitude" type="number" step="any" class="form-control" id="longitudeEdit" min="-180" max="180" placeholder="-46.633308" />
                            <span asp-validation-for="Longitude" class="text-danger"></span>
                            <small class="form-text text-danger d-none" id="lonErrorEdit">
                                Longitude deve estar entre -180 e 180
                            </small>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning small">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Importante:</strong> As coordenadas são necessárias para exibir a previsão do tempo na página de detalhes
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a asp-action="Detalhes" asp-route-id="@Model.Id" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        (function() {
            const btnBuscar = document.getElementById('btnBuscarCoordenadasEdit');
            const cidadeInput = document.getElementById('cidadeEdit');
            const latInput = document.getElementById('latitudeEdit');
            const lonInput = document.getElementById('longitudeEdit');
            const statusDiv = document.getElementById('coordenadasStatusEdit');
            const latError = document.getElementById('latErrorEdit');
            const lonError = document.getElementById('lonErrorEdit');

            function validateCoordinates() {
                let isValid = true;
                
                if (latInput.value) {
                    const lat = parseFloat(latInput.value);
                    if (isNaN(lat) || lat < -90 || lat > 90) {
                        latError.classList.remove('d-none');
                        latInput.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        latError.classList.add('d-none');
                        latInput.classList.remove('is-invalid');
                    }
                } else {
                    latError.classList.add('d-none');
                    latInput.classList.remove('is-invalid');
                }

                if (lonInput.value) {
                    const lon = parseFloat(lonInput.value);
                    if (isNaN(lon) || lon < -180 || lon > 180) {
                        lonError.classList.remove('d-none');
                        lonInput.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        lonError.classList.add('d-none');
                        lonInput.classList.remove('is-invalid');
                    }
                } else {
                    lonError.classList.add('d-none');
                    lonInput.classList.remove('is-invalid');
                }

                return isValid;
            }

            latInput.addEventListener('blur', validateCoordinates);
            lonInput.addEventListener('blur', validateCoordinates);

            // Validação no submit do formulário
            const form = latInput.closest('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    if (!validateCoordinates()) {
                        e.preventDefault();
                        // Scroll para o primeiro erro
                        const firstError = document.querySelector('.is-invalid');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            firstError.focus();
                        }
                    }
                });
            }

            if (btnBuscar && cidadeInput && latInput && lonInput) {
                btnBuscar.addEventListener('click', async function() {
                    const cidade = cidadeInput.value.trim();
                    if (!cidade) {
                        statusDiv.innerHTML = '<div class="alert alert-warning mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Digite o nome da cidade primeiro.</div>';
                        return;
                    }

                    btnBuscar.disabled = true;
                    btnBuscar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Buscando...';
                    statusDiv.innerHTML = '<div class="alert alert-info mb-0"><i class="fas fa-spinner fa-spin me-2"></i>Buscando coordenadas no Nominatim...</div>';

                    try {
                        const response = await fetch(`/Busca/BuscarCoordenadas?cidade=${encodeURIComponent(cidade)}`);
                        const data = await response.json();

                        if (data.sucesso) {
                            // Converter vírgula para ponto e arredondar para 6 casas decimais
                            const lat = parseFloat(String(data.latitude).replace(',', '.')).toFixed(6);
                            const lon = parseFloat(String(data.longitude).replace(',', '.')).toFixed(6);
                            latInput.value = lat;
                            lonInput.value = lon;
                            statusDiv.innerHTML = '<div class="alert alert-success mb-0"><i class="fas fa-check-circle me-2"></i>Coordenadas encontradas e preenchidas automaticamente!</div>';
                        } else {
                            statusDiv.innerHTML = `<div class="alert alert-warning mb-0"><i class="fas fa-exclamation-triangle me-2"></i>${data.mensagem || 'Cidade não encontrada.'}</div>`;
                        }
                    } catch (error) {
                        statusDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="fas fa-times-circle me-2"></i>Erro ao buscar coordenadas. Tente novamente.</div>';
                    } finally {
                        btnBuscar.disabled = false;
                        btnBuscar.innerHTML = '<i class="fas fa-search"></i> Buscar';
                    }
                });
            }
        })();
    </script>
}